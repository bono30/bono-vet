<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Bono Vet - Acompanhamento</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    nav a {
      margin-right: 15px;
      cursor: pointer;
      text-decoration: underline;
      color: blue;
    }
    h1, h2 { margin-bottom: 10px; }
    label { display: block; margin-top: 8px; }
    input, textarea, select {
      width: 100%;
      max-width: 400px;
    }
    button { margin-top: 10px; }
    .registro {
      border: 1px solid #ccc;
      padding: 8px;
      margin-top: 10px;
    }
    .bloco {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 15px;
    }
    #foto-preview {
      margin-top: 10px;
      max-width: 200px;
      display: block;
    }
    section { display: none; margin-top: 15px; }
    section.ativo { display: block; }
    .botoes-exame button { margin-right: 5px; margin-top: 5px; }
    #area-app { display: none; } /* escondido até logar */
    #info-usuario { margin-top: 10px; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>Bono Vet</h1>

  <!-- ÁREA DE LOGIN / CADASTRO -->
  <div class="bloco" id="area-auth">
    <h2>Acesso</h2>

    <div id="auth-forms">
      <!-- Login -->
      <div id="box-login">
        <h3>Entrar</h3>
        <form id="form-login">
          <label for="login-email">E-mail</label>
          <input type="email" id="login-email" required>

          <label for="login-senha">Senha</label>
          <input type="password" id="login-senha" required>

          <button type="submit">Entrar</button>
        </form>
      </div>

      <!-- Cadastro -->
      <div id="box-cadastro" style="margin-top:20px;">
        <h3>Criar conta</h3>
        <form id="form-cadastro">
          <label for="cad-email">E-mail</label>
          <input type="email" id="cad-email" required>

          <label for="cad-senha">Senha</label>
          <input type="password" id="cad-senha" required>

          <label for="cad-tipo">Sou</label>
          <select id="cad-tipo" required>
            <option value="">Selecione</option>
            <option value="tutor">Tutor</option>
            <option value="vet">Veterinário</option>
          </select>

          <!-- Apenas para veterinário -->
          <div id="area-crmv" style="display:none;">
            <label for="cad-crmv">CRMV (UF-XXXXX)</label>
            <input type="text" id="cad-crmv" placeholder="Ex.: MG-01234">
          </div>

          <button type="submit">Cadastrar</button>
        </form>
      </div>
    </div>

    <div id="info-usuario" style="display:none;">
      Logado como: <span id="info-email"></span> (<span id="info-tipo"></span>)
      <button id="btn-logout" type="button">Sair</button>
    </div>
  </div>

  <!-- ÁREA PRINCIPAL DO APP (escondida até logar) -->
  <div id="area-app">
    <!-- Navegação -->
    <nav>
      <a id="tab-dashboard">Dashboard</a>
      <a id="tab-registros">Registros diários</a>
      <a id="tab-exames">Exames</a>
    </nav>

    <!-- DASHBOARD -->
    <section id="sec-dashboard" class="ativo">
      <div class="bloco">
        <h2>Dados do cachorro</h2>
        <form id="form-cachorro">
          <label for="nome">Nome</label>
          <input type="text" id="nome" required>

          <label for="nascimento">Data de nascimento</label>
          <input type="date" id="nascimento" required>

          <label for="raca">Raça</label>
          <select id="raca" required>
            <option value="">Selecione a raça</option>
            <option value="SRD (vira-lata)">SRD (vira-lata)</option>
            <option value="Labrador Retriever">Labrador Retriever</option>
            <option value="Golden Retriever">Golden Retriever</option>
            <option value="Poodle">Poodle</option>
            <option value="Shih Tzu">Shih Tzu</option>
            <option value="Yorkshire Terrier">Yorkshire Terrier</option>
            <option value="Bulldog Francês">Bulldog Francês</option>
            <option value="Border Collie">Border Collie</option>
            <option value="Pastor Alemão">Pastor Alemão</option>
            <option value="Beagle">Beagle</option>
          </select>

          <label for="foto">Foto</label>
          <input type="file" id="foto" accept="image/*">

          <button type="submit" id="btn-salvar-cachorro">Salvar/Atualizar</button>
        </form>
        <img id="foto-preview" src="" alt="Foto do cachorro" style="display:none; max-width:200px;">
      </div>

      <div class="bloco">
        <h2>Informações salvas</h2>
        <p><strong>Nome:</strong> <span id="info-nome">-</span></p>
        <p><strong>Nascimento:</strong> <span id="info-nascimento">-</span></p>
        <p><strong>Raça:</strong> <span id="info-raca">-</span></p>
        <img id="info-foto" src="" alt="Foto salva do cachorro" style="max-width:200px; display:none;">
      </div>
    </section>

    <!-- REGISTROS DIÁRIOS -->
    <section id="sec-registros">
      <div class="bloco">
        <h2>Registrar dados do dia</h2>
        <form id="form-registro">
          <label for="data">Data</label>
          <input type="date" id="data" required>

          <label for="peso">Peso (kg)</label>
          <input type="number" id="peso" step="0.1" required>

          <label for="obs">Observações</label>
          <textarea id="obs" rows="3"></textarea>

          <button type="submit" id="btn-salvar-registro">Salvar registro</button>
        </form>
      </div>

      <div class="bloco">
        <h2>Registros salvos</h2>
        <div id="lista-registros"></div>
      </div>
    </section>

    <!-- EXAMES -->
    <section id="sec-exames">
      <div class="bloco">
        <h2>Cadastrar / editar exame</h2>
        <form id="form-exame">
          <input type="hidden" id="exame-id">

          <label for="data-exame">Data do exame</label>
          <input type="date" id="data-exame" required>

          <label for="tipo-exame">Tipo de exame</label>
          <select id="tipo-exame" required>
            <option value="">Selecione</option>
            <option value="sangue">Exame de sangue</option>
            <option value="imagem">Imagem (ultrassom, raio X)</option>
            <option value="cardio">Cardiológico (ecocardiograma, eletro)</option>
            <option value="outro">Outro</option>
          </select>

          <label for="descricao-exame">Descrição / observações</label>
          <textarea id="descricao-exame" rows="3"></textarea>

          <label for="valor1">Parâmetro 1 (ex.: creatinina)</label>
          <input type="number" id="valor1" step="0.01">

          <label for="valor2">Parâmetro 2 (ex.: ureia)</label>
          <input type="number" id="valor2" step="0.01">

          <label for="arquivo-exame">Arquivo do exame (PDF ou imagem)</label>
          <input type="file" id="arquivo-exame" accept=".pdf,image/*">

          <button type="submit" id="btn-salvar-exame">Salvar exame</button>
          <button type="button" id="btn-cancelar-edicao" style="display:none;">
            Cancelar edição
          </button>
        </form>
      </div>

      <div class="bloco">
        <h2>Exames salvos</h2>
        <div id="lista-exames"></div>
      </div>
    </section>
  </div>

  <script type="module">
    // --------- Imports Firebase ---------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getDatabase, ref, set, push, onValue, remove
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";
    import {
      getStorage, ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    // --------- Config do projeto ---------
    const firebaseConfig = {
      apiKey: "AIzaSyDbKzICgL6dgYz18zwf98WpaOZNcJ_sGSk",
      authDomain: "bono-vet.firebaseapp.com",
      databaseURL: "https://bono-vet-default-rtdb.firebaseio.com",
      projectId: "bono-vet",
      storageBucket: "bono-vet.firebasestorage.app",
      messagingSenderId: "922268528742",
      appId: "1:922268528742:web:be2b877ca6cd77144b3da7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    // --------- Estado global de usuário ---------
    let usuarioAtual = null;     // objeto do auth
    let tipoUsuario = null;      // "tutor" ou "vet"

    // --------- Utilidades ---------
    const areaAuth = document.getElementById("area-auth");
    const areaApp = document.getElementById("area-app");
    const infoUsuarioBox = document.getElementById("info-usuario");
    const infoEmailSpan = document.getElementById("info-email");
    const infoTipoSpan = document.getElementById("info-tipo");
    const btnLogout = document.getElementById("btn-logout");

    // Mostrar/ocultar campo CRMV conforme tipo no cadastro
    const selectTipoCadastro = document.getElementById("cad-tipo");
    const areaCrmv = document.getElementById("area-crmv");
    selectTipoCadastro.addEventListener("change", () => {
      areaCrmv.style.display = selectTipoCadastro.value === "vet" ? "block" : "none";
    });

    // Validação simples de CRMV: UF-XXXX a UF-XXXXXX
    function crmvValido(crmv) {
      const regex = /^[A-Z]{2}-\d{4,6}$/;
      return regex.test(crmv.toUpperCase());
    }

    // --------- Navegação entre abas ---------
    const secDashboard = document.getElementById("sec-dashboard");
    const secRegistros = document.getElementById("sec-registros");
    const secExames = document.getElementById("sec-exames");

    function mostrar(section) {
      secDashboard.classList.remove("ativo");
      secRegistros.classList.remove("ativo");
      secExames.classList.remove("ativo");
      section.classList.add("ativo");
    }

    document.getElementById("tab-dashboard").addEventListener("click", () => {
      mostrar(secDashboard);
    });
    document.getElementById("tab-registros").addEventListener("click", () => {
      mostrar(secRegistros);
    });
    document.getElementById("tab-exames").addEventListener("click", () => {
      mostrar(secExames);
    });

    // --------- Autenticação: cadastro ---------
    const formCadastro = document.getElementById("form-cadastro");
    formCadastro.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("cad-email").value;
      const senha = document.getElementById("cad-senha").value;
      const tipo = document.getElementById("cad-tipo").value;
      const crmv = document.getElementById("cad-crmv").value.trim();

      if (!tipo) {
        alert("Selecione se você é tutor ou veterinário.");
        return;
      }

      if (tipo === "vet") {
        if (!crmvValido(crmv)) {
          alert("CRMV inválido. Use o formato UF-XXXX ou UF-XXXXXX (ex.: MG-01234).");
          return;
        }
      }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, senha);
        const uid = cred.user.uid;

        // Salvar dados extras em /usuarios/{uid}
        await set(ref(db, "usuarios/" + uid), {
          email,
          tipo,
          crmv: tipo === "vet" ? crmv.toUpperCase() : null
        });

        alert("Cadastro realizado! Você já está logado.");
      } catch (err) {
        alert("Erro no cadastro: " + err.message);
      }
    });

    // --------- Autenticação: login ---------
    const formLogin = document.getElementById("form-login");
    formLogin.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("login-email").value;
      const senha = document.getElementById("login-senha").value;
      try {
        await signInWithEmailAndPassword(auth, email, senha);
      } catch (err) {
        alert("Erro ao entrar: " + err.message);
      }
    });

    btnLogout.addEventListener("click", async () => {
      await signOut(auth);
    });

    // --------- Reagir à mudança de usuário logado ---------
    onAuthStateChanged(auth, async (user) => {
      usuarioAtual = user;
      if (!user) {
        // Deslogado
        tipoUsuario = null;
        areaAuth.style.display = "block";
        areaApp.style.display = "none";
        infoUsuarioBox.style.display = "none";
        return;
      }

      // Logado: buscar tipo em /usuarios/{uid}
      const uid = user.uid;
      infoEmailSpan.textContent = user.email || "";
      infoUsuarioBox.style.display = "block";

      const snap = await (await import("https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js"))
        .get(ref(db, "usuarios/" + uid));
      // get() não está disponível via import parcial acima; para simplificar, usamos onValue uma vez:
      // mas para evitar complicação, vamos ler uma vez usando onValue dentro de uma Promise.

      // Implemento leitura simples:
      const usuariosRef = ref(db, "usuarios/" + uid);
      let dadosUsuario = null;
      await new Promise((resolve) => {
        onValue(usuariosRef, (s) => {
          dadosUsuario = s.val();
          resolve();
        }, { onlyOnce: true });
      });

      tipoUsuario = dadosUsuario?.tipo || "tutor";
      infoTipoSpan.textContent = tipoUsuario === "vet" ? "Veterinário" : "Tutor";

      // Mostrar app
      areaAuth.style.display = "none";
      areaApp.style.display = "block";

      // Se for veterinário, esconder botões de escrita na interface
      ajustarInterfacePorPapel();
    });

    function ajustarInterfacePorPapel() {
      const isVet = tipoUsuario === "vet";

      // Vet não pode salvar cachorro nem registros nem exames (apenas ver)
      document.getElementById("btn-salvar-cachorro").disabled = isVet;
      document.getElementById("btn-salvar-registro").disabled = isVet;
      document.getElementById("btn-salvar-exame").disabled = isVet;
    }

    // --------- DASHBOARD: dados + foto (somente tutor) ---------
    const inputFoto = document.getElementById("foto");
    const fotoPreview = document.getElementById("foto-preview");
    const infoNome = document.getElementById("info-nome");
    const infoNasc = document.getElementById("info-nascimento");
    const infoRaca = document.getElementById("info-raca");
    const infoFoto = document.getElementById("info-foto");
    const formCachorro = document.getElementById("form-cachorro");
    let fotoFile = null;

    inputFoto.addEventListener("change", () => {
      const file = inputFoto.files[0];
      fotoFile = file || null;
      if (file) {
        const url = URL.createObjectURL(file);
        fotoPreview.src = url;
        fotoPreview.style.display = "block";
      } else {
        fotoPreview.style.display = "none";
      }
    });

    formCachorro.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (tipoUsuario === "vet") {
        alert("Veterinário não pode editar os dados do cachorro.");
        return;
      }

      const nome = document.getElementById("nome").value;
      const nascimento = document.getElementById("nascimento").value;
      const raca = document.getElementById("raca").value;

      let fotoURL = null;
      if (fotoFile) {
        const caminho = `fotos/${Date.now()}_${fotoFile.name}`;
        const fotoRef = sRef(storage, caminho);
        await uploadBytes(fotoRef, fotoFile);
        fotoURL = await getDownloadURL(fotoRef);
      }

      const dados = { nome, nascimento, raca };
      if (fotoURL) dados.fotoURL = fotoURL;

      await set(ref(db, "cachorro"), dados);

      alert("Dados do cachorro salvos/atualizados!");
      formCachorro.reset();
      fotoPreview.style.display = "none";
      fotoFile = null;
    });

    onValue(ref(db, "cachorro"), (snapshot) => {
      const dados = snapshot.val();
      if (!dados) return;
      infoNome.textContent = dados.nome || "-";
      infoNasc.textContent = dados.nascimento || "-";
      infoRaca.textContent = dados.raca || "-";
      if (dados.fotoURL) {
        infoFoto.src = dados.fotoURL;
        infoFoto.style.display = "block";
      } else {
        infoFoto.style.display = "none";
      }
    });

    // --------- REGISTROS DIÁRIOS ---------
    const formRegistro = document.getElementById("form-registro");
    const divLista = document.getElementById("lista-registros");

    formRegistro.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (tipoUsuario === "vet") {
        alert("Veterinário não pode inserir registros diários.");
        return;
      }

      const data = document.getElementById("data").value;
      const peso = document.getElementById("peso").value;
      const obs = document.getElementById("obs").value;

      const registrosRef = ref(db, "registros");
      await push(registrosRef, {
        data,
        peso,
        obs,
        criadoEm: new Date().toISOString()
      });

      formRegistro.reset();
      alert("Registro salvo!");
    });

    const registrosRef = ref(db, "registros");
    onValue(registrosRef, (snapshot) => {
      const dados = snapshot.val();
      divLista.innerHTML = "";
      if (!dados) {
        divLista.innerHTML = "<p>Ainda não há registros.</p>";
        return;
      }
      const lista = Object.entries(dados);
      lista.sort((a, b) => {
        const d1 = new Date(a[1].criadoEm || 0);
        const d2 = new Date(b[1].criadoEm || 0);
        return d2 - d1;
      });
      for (const [id, reg] of lista) {
        const div = document.createElement("div");
        div.className = "registro";
        div.innerHTML = `
          <strong>Data:</strong> ${reg.data || "-"}<br>
          <strong>Peso:</strong> ${reg.peso || "-"} kg<br>
          <strong>Obs:</strong> ${reg.obs || ""}<br>
          <small>ID: ${id}</small>
        `;
        divLista.appendChild(div);
      }
    });

    // --------- EXAMES (criar, editar, excluir – só tutor) ---------
    const formExame = document.getElementById("form-exame");
    const divListaExames = document.getElementById("lista-exames");
    const inputArquivoExame = document.getElementById("arquivo-exame");
    const inputExameId = document.getElementById("exame-id");
    const btnCancelarEdicao = document.getElementById("btn-cancelar-edicao");

    let arquivoExameFile = null;

    inputArquivoExame.addEventListener("change", () => {
      const file = inputArquivoExame.files[0];
      arquivoExameFile = file || null;
    });

    function limparFormularioExame() {
      formExame.reset();
      inputExameId.value = "";
      arquivoExameFile = null;
      btnCancelarEdicao.style.display = "none";
    }

    btnCancelarEdicao.addEventListener("click", () => {
      limparFormularioExame();
    });

    formExame.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (tipoUsuario === "vet") {
        alert("Veterinário não pode editar ou criar exames; apenas visualizar.");
        return;
      }

      const idExistente = inputExameId.value || null;

      const dataExame = document.getElementById("data-exame").value;
      const tipoExame = document.getElementById("tipo-exame").value;
      const desc = document.getElementById("descricao-exame").value;
      const valor1 = document.getElementById("valor1").value;
      const valor2 = document.getElementById("valor2").value;

      let arquivoURL = null;

      if (arquivoExameFile) {
        const caminho = `exames/${Date.now()}_${arquivoExameFile.name}`;
        const arqRef = sRef(storage, caminho);
        await uploadBytes(arqRef, arquivoExameFile);
        arquivoURL = await getDownloadURL(arqRef);
      }

      const dados = {
        dataExame,
        tipoExame,
        desc,
        valor1: valor1 ? Number(valor1) : null,
        valor2: valor2 ? Number(valor2) : null,
        criadoEm: idExistente ? undefined : new Date().toISOString()
      };

      if (arquivoURL) {
        dados.arquivoURL = arquivoURL;
      }

      if (idExistente) {
        await set(ref(db, "exames/" + idExistente), dados);
        alert("Exame atualizado!");
      } else {
        const examesRef = ref(db, "exames");
        await push(examesRef, dados);
        alert("Exame salvo!");
      }

      limparFormularioExame();
    });

    const examesRef = ref(db, "exames");
    onValue(examesRef, (snapshot) => {
      const dados = snapshot.val();
      divListaExames.innerHTML = "";
      if (!dados) {
        divListaExames.innerHTML = "<p>Ainda não há exames.</p>";
        return;
      }

      const lista = Object.entries(dados);
      lista.sort((a, b) => {
        const d1 = new Date(a[1].dataExame || a[1].criadoEm || 0);
        const d2 = new Date(b[1].dataExame || b[1].criadoEm || 0);
        return d2 - d1;
      });

      for (const [id, ex] of lista) {
        const div = document.createElement("div");
        div.className = "registro";
        const temArquivo = !!ex.arquivoURL;
        div.innerHTML = `
          <strong>Data:</strong> ${ex.dataExame || "-"}<br>
          <strong>Tipo:</strong> ${ex.tipoExame || "-"}<br>
          <strong>Desc.:</strong> ${ex.desc || ""}<br>
          <strong>Parâmetro 1:</strong> ${ex.valor1 ?? "-"}<br>
          <strong>Parâmetro 2:</strong> ${ex.valor2 ?? "-"}<br>
          ${
            temArquivo
              ? `<a href="${ex.arquivoURL}" target="_blank">Abrir arquivo</a><br>`
              : "<em>Sem arquivo anexado</em><br>"
          }
          <div class="botoes-exame"></div>
          <small>ID: ${id}</small>
        `;
        const botoesDiv = div.querySelector(".botoes-exame");

        if (tipoUsuario !== "vet") {
          const btnEditar = document.createElement("button");
          btnEditar.type = "button";
          btnEditar.textContent = "Editar";
          btnEditar.addEventListener("click", () => {
            inputExameId.value = id;
            document.getElementById("data-exame").value = ex.dataExame || "";
            document.getElementById("tipo-exame").value = ex.tipoExame || "";
            document.getElementById("descricao-exame").value = ex.desc || "";
            document.getElementById("valor1").value =
              ex.valor1 !== null && ex.valor1 !== undefined ? ex.valor1 : "";
            document.getElementById("valor2").value =
              ex.valor2 !== null && ex.valor2 !== undefined ? ex.valor2 : "";
            arquivoExameFile = null;
            inputArquivoExame.value = "";
            btnCancelarEdicao.style.display = "inline-block";
            mostrar(secExames);
          });
          botoesDiv.appendChild(btnEditar);

          const btnExcluir = document.createElement("button");
          btnExcluir.type = "button";
          btnExcluir.textContent = "Excluir";
          btnExcluir.addEventListener("click", async () => {
            const ok = window.confirm("Tem certeza que deseja excluir este exame?");
            if (ok) {
              await remove(ref(db, "exames/" + id));
            }
          });
          botoesDiv.appendChild(btnExcluir);
        } else {
          botoesDiv.innerHTML = "<em>(Apenas visualização para veterinário)</em>";
        }

        divListaExames.appendChild(div);
      }
    });
  </script>
</body>
</html>
