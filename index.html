<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Bono Vet - Acompanhamento</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    nav a {
      margin-right: 15px;
      cursor: pointer;
      text-decoration: underline;
      color: blue;
    }
    h1, h2 { margin-bottom: 10px; }
    label { display: block; margin-top: 8px; }
    input, textarea, select {
      width: 100%;
      max-width: 400px;
    }
    button { margin-top: 10px; }
    .registro {
      border: 1px solid #ccc;
      padding: 8px;
      margin-top: 10px;
    }
    .bloco {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 15px;
    }
    #foto-preview {
      margin-top: 10px;
      max-width: 200px;
      display: block;
    }
    section { display: none; margin-top: 15px; }
    section.ativo { display: block; }
    .botoes-exame button,
    .botoes-receita button,
    .botoes-registro button { margin-right: 5px; margin-top: 5px; }
    #area-app { display: none; }
    #info-usuario-barra {
      display: none;
      margin: 10px 0;
      padding: 8px;
      background: #f3f3f3;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    #info-usuario-barra span {
      font-weight: bold;
    }
    .comentario { margin-top: 5px; padding:4px; border-left:3px solid #ccc; font-size:0.9rem; }
    #link-esqueci-senha {
      margin-top: 5px;
      display: inline-block;
      font-size: 0.85rem;
      color: blue;
      text-decoration: underline;
      cursor: pointer;
    }
    #box-reset-senha {
      display: none;
      margin-top: 10px;
      padding: 8px;
      border: 1px dashed #ccc;
      background: #fafafa;
      font-size: 0.9rem;
    }
    .filtros {
      margin-top: 10px;
      padding: 8px;
      background: #f7f7f7;
      border: 1px solid #ddd;
      font-size: 0.9rem;
    }
    .filtros label {
      display: inline-block;
      margin-right: 10px;
    }
    .filtros input,
    .filtros select {
      width: auto;
      max-width: 200px;
    }
    /* Área de gráficos de exames */
    #sec-graficos-exames {
      margin-top: 15px;
      border-top: 1px dashed #ccc;
      padding-top: 10px;
    }
    #lista-exames-grafico {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 6px;
      margin-top: 6px;
      font-size: 0.9rem;
    }
    #lista-exames-grafico label {
      display: block;
      margin: 2px 0;
    }
    #area-grafico-renderizado {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      min-height: 80px;
      font-size: 0.9rem;
      background: #fafafa;
      white-space: pre-wrap;
      font-family: Consolas, monospace;
    }
  </style>
</head>
<body>
  <h1>Bono Vet</h1>

  <!-- BARRA DE USUARIO / SAIR -->
  <div id="info-usuario-barra">
    Logado como: <span id="info-nome-usuario"></span>
    &lt;<span id="info-email"></span>&gt;
    (<span id="info-tipo"></span>)
    <button id="btn-logout" type="button">Sair</button>
  </div>

  <!-- LOGIN / CADASTRO -->
  <div class="bloco" id="area-auth">
    <h2>Acesso</h2>

    <div id="auth-forms">
      <div id="box-login">
        <h3>Entrar</h3>
        <form id="form-login">
          <label for="login-email">E-mail</label>
          <input type="email" id="login-email" required>

          <label for="login-senha">Senha</label>
          <input type="password" id="login-senha" required>

          <button type="submit">Entrar</button>
        </form>

        <span id="link-esqueci-senha">Esqueci minha senha</span>

        <div id="box-reset-senha">
          <p>Informe seu e-mail para receber um link de redefinição de senha.</p>
          <form id="form-reset-senha">
            <label for="reset-email">E-mail cadastrado</label>
            <input type="email" id="reset-email" required>
            <button type="submit">Enviar link de redefinição</button>
          </form>
        </div>
      </div>

      <div id="box-cadastro" style="margin-top:20px;">
        <h3>Criar conta</h3>
        <form id="form-cadastro">
          <label for="cad-nome">Nome completo</label>
          <input type="text" id="cad-nome" required>

          <label for="cad-email">E-mail</label>
          <input type="email" id="cad-email" required>

          <label for="cad-senha">Senha</label>
          <input type="password" id="cad-senha" required>

          <label for="cad-tipo">Sou</label>
          <select id="cad-tipo" required>
            <option value="">Selecione</option>
            <option value="tutor">Tutor(a)</option>
            <option value="vet">Veterinário(a)</option>
          </select>

          <div id="area-crmv" style="display:none;">
            <label for="cad-crmv">CRMV (UF-XXXXX)</label>
            <input type="text" id="cad-crmv" placeholder="Ex.: MG-01234">
          </div>

          <button type="submit">Cadastrar</button>
        </form>
      </div>
    </div>
  </div>

  <!-- APLICACAO -->
  <div id="area-app">
    <nav>
      <a id="tab-dashboard">Dashboard</a>
      <a id="tab-registros">Registros diários</a>
      <a id="tab-exames">Exames</a>
      <a id="tab-receitas">Receitas/Pedidos</a>
    </nav>

    <!-- DASHBOARD -->
    <section id="sec-dashboard" class="ativo">
      <div class="bloco">
        <h2>Dados do cachorro</h2>
        <form id="form-cachorro">
          <label for="nome">Nome</label>
          <input type="text" id="nome" required>

          <label for="nascimento">Data de nascimento</label>
          <input type="date" id="nascimento" required>

          <label for="raca">Raça</label>
          <select id="raca" required>
            <option value="">Selecione a raça</option>
            <option value="SRD (vira-lata)">SRD (vira-lata)</option>
            <option value="Labrador Retriever">Labrador Retriever</option>
            <option value="Golden Retriever">Golden Retriever</option>
            <option value="Poodle">Poodle</option>
            <option value="Shih Tzu">Shih Tzu</option>
            <option value="Yorkshire Terrier">Yorkshire Terrier</option>
            <option value="Bulldog Francês">Bulldog Francês</option>
            <option value="Border Collie">Border Collie</option>
            <option value="Pastor Alemão">Pastor Alemão</option>
            <option value="Beagle">Beagle</option>
          </select>

          <label for="foto">Foto</label>
          <input type="file" id="foto" accept="image/*">

          <button type="submit" id="btn-salvar-cachorro">Salvar/Atualizar</button>
        </form>
        <img id="foto-preview" src="" alt="Foto do cachorro" style="display:none; max-width:200px;">
      </div>

      <div class="bloco">
        <h2>Informações salvas</h2>
        <p><strong>Nome:</strong> <span id="info-nome">-</span></p>
        <p><strong>Nascimento:</strong> <span id="info-nascimento">-</span></p>
        <p><strong>Raça:</strong> <span id="info-raca">-</span></p>
        <img id="info-foto" src="" alt="Foto salva do cachorro" style="max-width:200px; display:none;">
      </div>

      <!-- AUTORIZACAO DE VETERINARIOS (TUTOR) -->
      <div class="bloco" id="bloco-autorizacoes">
        <h2>Autorizar veterinário</h2>
        <p>Permite que um veterinário, identificado por CRMV, visualize exames, registros e registre comentários/pedidos.</p>
        <form id="form-autorizacao">
          <label for="nome-vet-aut">Nome do veterinário (opcional)</label>
          <input type="text" id="nome-vet-aut">

          <label for="crmv-vet-aut">CRMV do veterinário (UF-XXXXX)</label>
          <input type="text" id="crmv-vet-aut" required>
          <button type="submit">Autorizar veterinário</button>
        </form>

        <div class="filtros" style="margin-top:10px;">
          <strong>Filtrar veterinários autorizados:</strong><br>
          <label>Texto (CRMV ou nome)
            <input type="text" id="filtro-vet-texto" placeholder="Ex.: MG-01234">
          </label>
          <button type="button" id="btn-limpar-filtro-vet">Limpar</button>
        </div>

        <div style="margin-top:10px;">
          <h3>Veterinários autorizados</h3>
          <ul id="lista-autorizados"></ul>
        </div>
      </div>

      <!-- VISUALIZACAO DE AUTORIZACAO PARA VETS -->
      <div class="bloco" id="bloco-info-vet" style="display:none;">
        <h2>Informações de acesso como veterinário</h2>
        <p id="texto-autorizacao-vet"></p>
      </div>
    </section>

    <!-- SELECAO DE TUTOR PARA VETERINARIO -->
    <div class="bloco" id="bloco-selecao-tutor-vet" style="display:none;">
      <h2>Seleção de tutor (veterinário)</h2>
      <p>
        Quando mais de um tutor autorizar seu CRMV, escolha abaixo qual tutor deseja visualizar/atender.
      </p>
      <label for="select-tutor-vet">Tutor selecionado</label>
      <select id="select-tutor-vet">
        <option value="">Nenhum tutor selecionado</option>
      </select>
      <p id="info-tutor-vet" style="margin-top:8px; font-size:0.9rem; color:#555;"></p>
    </div>

    <!-- REGISTROS DIARIOS -->
    <section id="sec-registros">
      <div class="bloco">
        <h2>Registrar dados do dia</h2>
        <form id="form-registro">
          <label for="data">Data</label>
          <input type="date" id="data" required>

          <label for="peso">Peso (kg)</label>
          <input type="number" id="peso" step="0.1" required>

          <label for="obs">Observações</label>
          <textarea id="obs" rows="3"></textarea>

          <button type="submit" id="btn-salvar-registro">Salvar registro</button>
        </form>
      </div>

      <div class="bloco">
        <h2>Registros salvos</h2>

        <div class="filtros">
          <strong>Filtros (tutor):</strong><br>
          <label>Data inicial
            <input type="date" id="filtro-reg-data-inicio">
          </label>
          <label>Data final
            <input type="date" id="filtro-reg-data-fim">
          </label>
          <label>Texto em observações
            <input type="text" id="filtro-reg-texto" placeholder="Busca em observações">
          </label>
          <button type="button" id="btn-limpar-filtro-reg">Limpar filtros</button>
        </div>

        <div id="lista-registros"></div>
      </div>
    </section>

    <!-- EXAMES -->
    <section id="sec-exames">
      <div class="bloco">
        <h2>Cadastrar / editar exame</h2>
        <form id="form-exame">
          <input type="hidden" id="exame-id">

          <label for="data-exame">Data do exame</label>
          <input type="date" id="data-exame" required>

          <label for="tipo-exame">Tipo de exame</label>
          <select id="tipo-exame" required>
            <option value="">Selecione</option>
            <option value="sangue">Exame de sangue</option>
            <option value="imagem">Imagem (ultrassom, raio X)</option>
            <option value="cardio">Cardiológico (ecocardiograma, eletro)</option>
            <option value="outro">Outro</option>
          </select>

          <label for="descricao-exame">Descrição / observações</label>
          <textarea id="descricao-exame" rows="3"></textarea>

          <label for="arquivo-exame">Arquivo do exame (PDF ou imagem)</label>
          <input type="file" id="arquivo-exame" accept=".pdf,image/*">

          <button type="submit" id="btn-salvar-exame">Salvar exame</button>
          <button type="button" id="btn-cancelar-edicao" style="display:none;">
            Cancelar edição
          </button>
        </form>
      </div>

      <div class="bloco">
        <h2>Exames salvos</h2>

        <div class="filtros">
          <strong>Filtros (tutor):</strong><br>
          <label>Data inicial
            <input type="date" id="filtro-ex-data-inicio">
          </label>
          <label>Data final
            <input type="date" id="filtro-ex-data-fim">
          </label>
          <label>Tipo
            <select id="filtro-ex-tipo">
              <option value="">Todos</option>
              <option value="sangue">Exame de sangue</option>
              <option value="imagem">Imagem</option>
              <option value="cardio">Cardiológico</option>
              <option value="outro">Outro</option>
            </select>
          </label>
          <label>Texto em descrição
            <input type="text" id="filtro-ex-texto" placeholder="Busca em descrição">
          </label>
          <button type="button" id="btn-limpar-filtro-ex">Limpar filtros</button>
        </div>

        <div id="lista-exames"></div>
      </div>

      <!-- NOVO BLOCO: GRÁFICOS DE EXAMES -->
      <div class="bloco" id="sec-graficos-exames">
        <h2>Gráficos de exames</h2>
        <p style="font-size:0.9rem;">
          Selecione um tipo de exame, escolha até 10 exames da lista e clique em "Gerar gráfico".
        </p>

        <label for="grafico-tipo-exame">Tipo de exame para o gráfico</label>
        <select id="grafico-tipo-exame">
          <option value="">Selecione</option>
          <option value="sangue">Exame de sangue</option>
          <option value="imagem">Imagem</option>
          <option value="cardio">Cardiológico</option>
          <option value="outro">Outro</option>
        </select>

        <label for="grafico-tipo">Tipo de gráfico</label>
        <select id="grafico-tipo">
          <option value="linha">Linha</option>
          <option value="barra">Barras</option>
          <option value="pontos">Pontos</option>
        </select>

        <div style="margin-top:8px;">
          <strong>Exames disponíveis para este tipo (máx. 10 selecionados):</strong>
          <div id="lista-exames-grafico">
            <em>Selecione um tipo de exame acima.</em>
          </div>
        </div>

        <button type="button" id="btn-gerar-grafico">Gerar gráfico</button>

        <div id="area-grafico-renderizado">
          Aguardando seleção de exames e geração de gráfico.
        </div>
      </div>
    </section>

    <!-- RECEITAS / PEDIDOS -->
    <section id="sec-receitas">
      <div class="bloco">
        <h2>Receitas e pedidos</h2>
        <form id="form-receita">
          <label for="tipo-receita">Tipo</label>
          <select id="tipo-receita" required>
            <option value="">Selecione</option>
            <option value="receita">Receita médica</option>
            <option value="pedido-exame">Pedido de exame</option>
          </select>

          <label for="descricao-receita">Descrição / itens</label>
          <textarea id="descricao-receita" rows="3" required></textarea>

          <label for="comentario-receita">Comentário do veterinário</label>
          <textarea id="comentario-receita" rows="2"></textarea>

          <label for="arquivo-receita">Arquivo PDF (obrigatório)</label>
          <input type="file" id="arquivo-receita" accept="application/pdf" required>

          <button type="submit" id="btn-salvar-receita">Salvar receita/pedido</button>
        </form>
      </div>

      <div class="bloco">
        <h2>Receitas / pedidos salvos</h2>

        <div class="filtros">
          <strong>Filtros (tutor):</strong><br>
          <label>Tipo
            <select id="filtro-rec-tipo">
              <option value="">Todos</option>
              <option value="receita">Receita médica</option>
              <option value="pedido-exame">Pedido de exame</option>
            </select>
          </label>
          <label>Texto em descrição/comentário
            <input type="text" id="filtro-rec-texto" placeholder="Busca em descrição/comentário">
          </label>
          <button type="button" id="btn-limpar-filtro-rec">Limpar filtros</button>
        </div>

        <div id="lista-receitas"></div>
      </div>
    </section>
  </div>

  <!-- PDF.js para ler laudos -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js"></script>
  <script>
    if (window['pdfjsLib']) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js";
    }
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getDatabase, ref, set, push, onValue, remove, update
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";
    import {
      getStorage, ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDbKzICgL6dgYz18zwf98WpaOZNcJ_sGSk",
      authDomain: "bono-vet.firebaseapp.com",
      databaseURL: "https://bono-vet-default-rtdb.firebaseio.com",
      projectId: "bono-vet",
      storageBucket: "bono-vet.firebasestorage.app",
      messagingSenderId: "922268528742",
      appId: "1:922268528742:web:be2b877ca6cd77144b3da7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    let usuarioAtual = null;
    let tipoUsuario = null;
    let nomeUsuario = "";
    let crmvUsuario = null;
    let uidTutorAutorizador = null;

    let registrosCache = [];
    let examesCache = [];
    let receitasCache = [];
    let vetsAutorizadosCache = [];
    let tutoresDoVet = [];
    let tutorSelecionadoUid = null;

    const areaAuth = document.getElementById("area-auth");
    const areaApp = document.getElementById("area-app");
    const infoBarra = document.getElementById("info-usuario-barra");
    const infoEmailSpan = document.getElementById("info-email");
    const infoNomeUsuarioSpan = document.getElementById("info-nome-usuario");
    const infoTipoSpan = document.getElementById("info-tipo");
    const btnLogout = document.getElementById("btn-logout");

    const selectTipoCadastro = document.getElementById("cad-tipo");
    const areaCrmv = document.getElementById("area-crmv");
    selectTipoCadastro.addEventListener("change", () => {
      areaCrmv.style.display = selectTipoCadastro.value === "vet" ? "block" : "none";
    });

    const secDashboard = document.getElementById("sec-dashboard");
    const secRegistros = document.getElementById("sec-registros");
    const secExames = document.getElementById("sec-exames");
    const secReceitas = document.getElementById("sec-receitas");

    function mostrar(section) {
      secDashboard.classList.remove("ativo");
      secRegistros.classList.remove("ativo");
      secExames.classList.remove("ativo");
      secReceitas.classList.remove("ativo");
      section.classList.add("ativo");
    }

    document.getElementById("tab-dashboard").addEventListener("click", () => {
      mostrar(secDashboard);
    });
    document.getElementById("tab-registros").addEventListener("click", () => {
      mostrar(secRegistros);
    });
    document.getElementById("tab-exames").addEventListener("click", () => {
      mostrar(secExames);
    });
    document.getElementById("tab-receitas").addEventListener("click", () => {
      mostrar(secReceitas);
    });

    const linkEsqueciSenha = document.getElementById("link-esqueci-senha");
    const boxResetSenha = document.getElementById("box-reset-senha");
    linkEsqueciSenha.addEventListener("click", () => {
      boxResetSenha.style.display = boxResetSenha.style.display === "none" ? "block" : "none";
    });

    const formResetSenha = document.getElementById("form-reset-senha");
    formResetSenha.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("reset-email").value.trim();
      if (!email) {
        alert("Informe o e-mail cadastrado.");
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        alert("Se este e-mail estiver cadastrado, você receberá uma mensagem com o link para redefinir a senha.");
        formResetSenha.reset();
        boxResetSenha.style.display = "none";
      } catch (err) {
        alert("Erro ao enviar e-mail de redefinição: " + err.message);
      }
    });

    const formCadastro = document.getElementById("form-cadastro");
    formCadastro.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nome = document.getElementById("cad-nome").value.trim();
      const email = document.getElementById("cad-email").value;
      const senha = document.getElementById("cad-senha").value;
      const tipo = document.getElementById("cad-tipo").value;
      const crmv = document.getElementById("cad-crmv").value.trim();

      if (!nome) {
        alert("Informe o nome completo.");
        return;
      }
      if (!tipo) {
        alert("Selecione se você é tutor(a) ou veterinário(a).");
        return;
      }
      if (tipo === "vet" && !crmvValido(crmv)) {
        alert("CRMV inválido. Use o formato UF-XXXX ou UF-XXXXXX (ex.: MG-01234).");
        return;
      }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, senha);
        const uid = cred.user.uid;

        await set(ref(db, "usuarios/" + uid), {
          nome,
          email,
          tipo,
          crmv: tipo === "vet" ? crmv.toUpperCase() : null
        });

        alert("Cadastro realizado! Você já está logado.");
      } catch (err) {
        alert("Erro no cadastro: " + err.message);
      }
    });

    const formLogin = document.getElementById("form-login");
    formLogin.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("login-email").value;
      const senha = document.getElementById("login-senha").value;
      try {
        await signInWithEmailAndPassword(auth, email, senha);
      } catch (err) {
        alert("Erro ao entrar: " + err.message);
      }
    });

    btnLogout.addEventListener("click", async () => {
      await signOut(auth);
    });

    function buscarDadosUsuario(uid) {
      return new Promise((resolve) => {
        onValue(ref(db, "usuarios/" + uid), (s) => {
          resolve(s.val());
        }, { onlyOnce: true });
      });
    }

    const blocoAutorizacoes = document.getElementById("bloco-autorizacoes");
    const blocoInfoVet = document.getElementById("bloco-info-vet");
    const textoAutorizacaoVet = document.getElementById("texto-autorizacao-vet");
    const listaAutorizados = document.getElementById("lista-autorizados");
    const filtroVetTexto = document.getElementById("filtro-vet-texto");
    const btnLimparFiltroVet = document.getElementById("btn-limpar-filtro-vet");

    function renderizarListaVetsAutorizados(uidTutor) {
      listaAutorizados.innerHTML = "";
      const texto = (filtroVetTexto.value || "").trim().toLowerCase();

      let lista = vetsAutorizadosCache;
      if (texto) {
        lista = lista.filter(v =>
          v.crmv.toLowerCase().includes(texto) ||
          (v.nomeVet || "").toLowerCase().includes(texto)
        );
      }

      if (!lista.length) {
        listaAutorizados.innerHTML = "<li>Nenhum veterinário encontrado com esse filtro.</li>";
        return;
      }

      lista.forEach((v) => {
        const li = document.createElement("li");
        const label = v.nomeVet ? `${v.crmv} - ${v.nomeVet}` : v.crmv;
        li.textContent = label;

        const btnRem = document.createElement("button");
        btnRem.type = "button";
        btnRem.textContent = "Revogar acesso";
        btnRem.style.marginLeft = "8px";
        btnRem.addEventListener("click", async () => {
          const ok = window.confirm("Remover o acesso deste CRMV?");
          if (ok) {
            await remove(ref(db, "autorizacoes/" + uidTutor + "/" + v.crmv));
          }
        });
        li.appendChild(btnRem);

        listaAutorizados.appendChild(li);
      });
    }

    async function carregarAutorizacoesTutor(uidTutor) {
      onValue(ref(db, "autorizacoes/" + uidTutor), (s) => {
        const dados = s.val();
        if (!dados) {
          vetsAutorizadosCache = [];
          listaAutorizados.innerHTML = "<li>Nenhum veterinário autorizado ainda.</li>";
          return;
        }
        vetsAutorizadosCache = Object.keys(dados).map((crmv) => ({
          crmv,
          nomeVet: null
        }));
        renderizarListaVetsAutorizados(uidTutor);
      });

      filtroVetTexto.addEventListener("input", () => {
        renderizarListaVetsAutorizados(uidTutor);
      });
      btnLimparFiltroVet.addEventListener("click", () => {
        filtroVetTexto.value = "";
        renderizarListaVetsAutorizados(uidTutor);
      });
    }

    async function descobrirTutoresParaVet(crmvVet) {
      return new Promise((resolve) => {
        onValue(ref(db, "autorizacoes"), async (s) => {
          const todos = s.val();
          if (!todos) {
            resolve([]);
            return;
          }

          const promessas = [];

          for (const uidTutor in todos) {
            const porTutor = todos[uidTutor];
            if (porTutor && porTutor[crmvVet]) {
              promessas.push(
                new Promise((res2) => {
                  onValue(ref(db, "usuarios/" + uidTutor), (snapUser) => {
                    const u = snapUser.val();
                    const nomeTutor = u?.nome || "(Tutor sem nome)";
                    res2({ uidTutor, nomeTutor });
                  }, { onlyOnce: true });
                })
              );
            }
          }

          const basicos = await Promise.all(promessas);

          const promessasCao = basicos.map((b) =>
            new Promise((res3) => {
              onValue(ref(db, "tutores/" + b.uidTutor + "/cachorro"), (snapCao) => {
                const c = snapCao.val();
                const nomeCachorro = c?.nome || "(cachorro não cadastrado)";
                res3({
                  uidTutor: b.uidTutor,
                  nomeTutor: b.nomeTutor,
                  nomeCachorro
                });
              }, { onlyOnce: true });
            })
          );

          const completos = await Promise.all(promessasCao);
          resolve(completos);
        }, { onlyOnce: true });
      });
    }

    onAuthStateChanged(auth, async (user) => {
      usuarioAtual = user;
      uidTutorAutorizador = null;

      if (!user) {
        tipoUsuario = null;
        nomeUsuario = "";
        crmvUsuario = null;
        areaAuth.style.display = "block";
        areaApp.style.display = "none";
        infoBarra.style.display = "none";
        return;
      }

      const uid = user.uid;
      const dadosUsuario = await buscarDadosUsuario(uid);

      tipoUsuario = dadosUsuario?.tipo || "tutor";
      nomeUsuario = dadosUsuario?.nome || "";
      crmvUsuario = dadosUsuario?.crmv || null;

      infoEmailSpan.textContent = user.email || "";
      infoNomeUsuarioSpan.textContent = nomeUsuario || "(sem nome)";
      infoTipoSpan.textContent = tipoUsuario === "vet" ? "Veterinário(a)" : "Tutor(a)";

      infoBarra.style.display = "block";
      areaAuth.style.display = "none";
      areaApp.style.display = "block";

      if (tipoUsuario === "tutor") {
        blocoAutorizacoes.style.display = "block";
        blocoInfoVet.style.display = "none";
        document.getElementById("bloco-selecao-tutor-vet").style.display = "none";
        carregarAutorizacoesTutor(uid);
      } else {
        blocoAutorizacoes.style.display = "none";
        blocoInfoVet.style.display = "block";
        const blocoSelecaoTutorVet = document.getElementById("bloco-selecao-tutor-vet");
        const selectTutorVet = document.getElementById("select-tutor-vet");
        const infoTutorVet = document.getElementById("info-tutor-vet");

        if (!crmvUsuario) {
          textoAutorizacaoVet.textContent =
            "Seu cadastro de veterinário não possui CRMV registrado.";
          blocoSelecaoTutorVet.style.display = "none";
        } else {
          tutoresDoVet = await descobrirTutoresParaVet(crmvUsuario);
          if (!tutoresDoVet.length) {
            textoAutorizacaoVet.textContent =
              "Nenhum tutor autorizou ainda o seu CRMV. Você verá a estrutura, mas não haverá dados associados.";
            blocoSelecaoTutorVet.style.display = "none";
            uidTutorAutorizador = null;
            tutorSelecionadoUid = null;
          } else {
            textoAutorizacaoVet.textContent =
              "Há tutores que autorizaram seu CRMV. Selecione abaixo qual tutor deseja visualizar.";
            blocoSelecaoTutorVet.style.display = "block";

            selectTutorVet.innerHTML = '<option value="">Selecione um tutor</option>';
            tutoresDoVet.forEach((t) => {
              const opt = document.createElement("option");
              opt.value = t.uidTutor;
              opt.textContent = `${t.nomeTutor} - ${t.nomeCachorro}`;
              selectTutorVet.appendChild(opt);
            });

            if (tutorSelecionadoUid && tutoresDoVet.some(t => t.uidTutor === tutorSelecionadoUid)) {
              selectTutorVet.value = tutorSelecionadoUid;
            } else {
              tutorSelecionadoUid = tutoresDoVet[0].uidTutor;
              selectTutorVet.value = tutorSelecionadoUid;
            }

            const tutorAtual = tutoresDoVet.find(t => t.uidTutor === tutorSelecionadoUid);
            uidTutorAutorizador = tutorSelecionadoUid;
            infoTutorVet.textContent = tutorAtual
              ? `Tutor selecionado: ${tutorAtual.nomeTutor} (cão: ${tutorAtual.nomeCachorro})`
              : "";

            selectTutorVet.onchange = () => {
              tutorSelecionadoUid = selectTutorVet.value || null;
              uidTutorAutorizador = tutorSelecionadoUid;
              const tSel = tutoresDoVet.find(t => t.uidTutor === tutorSelecionadoUid);
              infoTutorVet.textContent = tSel
                ? `Tutor selecionado: ${tSel.nomeTutor} (cão: ${tSel.nomeCachorro})`
                : "";
              iniciarListenersDados();
            };
          }
        }
      }

      ajustarInterfacePorPapel();
      iniciarListenersDados();
    });

    function ajustarInterfacePorPapel() {
      const isVet = tipoUsuario === "vet";
      document.getElementById("btn-salvar-cachorro").disabled = isVet;
      document.getElementById("btn-salvar-registro").disabled = isVet;
      document.getElementById("btn-salvar-exame").disabled = false;
      document.getElementById("btn-salvar-receita").disabled = !isVet;
    }

    function getOwnerUidParaEscrita() {
      if (tipoUsuario === "tutor") return usuarioAtual?.uid || null;
      if (tipoUsuario === "vet") return uidTutorAutorizador || null;
      return null;
    }

    function getOwnerUidParaLeitura() {
      if (tipoUsuario === "tutor") return usuarioAtual?.uid || null;
      if (tipoUsuario === "vet") return uidTutorAutorizador || null;
      return null;
    }

    const formAutorizacao = document.getElementById("form-autorizacao");
    formAutorizacao.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (tipoUsuario !== "tutor") {
        alert("Apenas tutores podem autorizar veterinários.");
        return;
      }
      const crmv = document.getElementById("crmv-vet-aut").value.trim();
      if (!crmvValido(crmv)) {
        alert("CRMV inválido. Use o formato UF-XXXX ou UF-XXXXXX (ex.: MG-01234).");
        return;
      }
      const uidTutor = usuarioAtual.uid;
      await set(ref(db, "autorizacoes/" + uidTutor + "/" + crmv.toUpperCase()), true);
      alert("Veterinário autorizado com sucesso.");
      formAutorizacao.reset();
    });

    function crmvValido(crmv) {
      const regex = /^[A-Z]{2}-\d{4,6}$/;
      return regex.test(crmv.toUpperCase());
    }

    const inputFoto = document.getElementById("foto");
    const fotoPreview = document.getElementById("foto-preview");
    const infoNome = document.getElementById("info-nome");
    const infoNasc = document.getElementById("info-nascimento");
    const infoRaca = document.getElementById("info-raca");
    const infoFoto = document.getElementById("info-foto");
    const formCachorro = document.getElementById("form-cachorro");
    let fotoFile = null;

    inputFoto.addEventListener("change", () => {
      const file = inputFoto.files[0];
      fotoFile = file || null;
      if (file) {
        const url = URL.createObjectURL(file);
        fotoPreview.src = url;
        fotoPreview.style.display = "block";
      } else {
        fotoPreview.style.display = "none";
      }
    });

    formCachorro.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (tipoUsuario === "vet") {
        alert("Veterinário(a) não pode editar os dados do cachorro.");
        return;
      }
      const ownerUid = getOwnerUidParaEscrita();
      if (!ownerUid) {
        alert("Usuário não identificado.");
        return;
      }

      const nome = document.getElementById("nome").value;
      const nascimento = document.getElementById("nascimento").value;
      const raca = document.getElementById("raca").value;

      let fotoURL = null;
      if (fotoFile) {
        const caminho = `fotos/${ownerUid}/${Date.now()}_${fotoFile.name}`;
        const fotoRef = sRef(storage, caminho);
        await uploadBytes(fotoRef, fotoFile);
        fotoURL = await getDownloadURL(fotoRef);
      }

      const dados = { nome, nascimento, raca };
      if (fotoURL) dados.fotoURL = fotoURL;

      await set(ref(db, "tutores/" + ownerUid + "/cachorro"), dados);

      alert("Dados do cachorro salvos/atualizados!");
      formCachorro.reset();
      fotoPreview.style.display = "none";
      fotoFile = null;
    });

    function iniciarListenersDados() {
      const ownerUid = getOwnerUidParaLeitura();
      if (!ownerUid) return;

      onValue(ref(db, "tutores/" + ownerUid + "/cachorro"), (snapshot) => {
        const dados = snapshot.val();
        if (!dados) return;
        infoNome.textContent = dados.nome || "-";
        infoNasc.textContent = dados.nascimento || "-";
        infoRaca.textContent = dados.raca || "-";
        if (dados.fotoURL) {
          infoFoto.src = dados.fotoURL;
          infoFoto.style.display = "block";
        } else {
          infoFoto.style.display = "none";
        }
      });

      iniciarListenerRegistros(ownerUid);
      iniciarListenerExames(ownerUid);
      iniciarListenerReceitas(ownerUid);
    }

    // FUNÇÃO: extrair texto do PDF (PDF.js)
    async function extrairTextoDoPDF(file) {
      if (!window.pdfjsLib) {
        throw new Error("PDF.js não carregado.");
      }
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let textoCompleto = "";

      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str);
        textoCompleto += strings.join(" ") + "\n";
      }

      return textoCompleto;
    }

       // FUNÇÃO: parser específico para laudos com bloco "FÓSFORO" (canino)
    function analisarLaudoLaboratorial(texto) {
      const parametros = [];

      // Normalizar quebras de linha
      const linhas = texto
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(l => l);

      // Procurar título "FÓSFORO" (aceita com ou sem acento, maiúsculo/minúsculo)
      for (let i = 0; i < linhas.length; i++) {
        const linha = linhas[i];

        // Normalizar para comparação
        const normalizada = linha
          .toUpperCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, ""); // remove acentos

        if (normalizada === "FOSFORO") {
          // Próximas linhas costumam trazer "RESULTADO" e "Canino : x a y mg/dL"
          const bloco = linhas.slice(i, i + 6).join(" ");

          // Ex.: "RESULTADO...........: 4,40 mg/dL Canino : 2,7 a 5,4 mg/dL"
          const regex = /RESULTADO[^:]*:\s*([\d.,]+)\s*([a-zA-Z/%µ]+)[\s\S]*?Canino\s*:\s*([\d.,]+)\s*a\s*([\d.,]+)\s*([a-zA-Z/%µ]+)/i;
          const m = bloco.match(regex);
          if (m) {
            const valorStr = m[1].replace(",", ".");
            const unidadeResultado = (m[2] || "").trim();
            const refMinStr = m[3].replace(",", ".");
            const refMaxStr = m[4].replace(",", ".");
            const unidadeRef = (m[5] || "").trim();

            const valor = parseFloat(valorStr);
            const refMin = parseFloat(refMinStr);
            const refMax = parseFloat(refMaxStr);

            if (!isNaN(valor) && !isNaN(refMin) && !isNaN(refMax)) {
              let status = "normal";
              if (valor < refMin) status = "baixo";
              else if (valor > refMax) status = "alto";

              // Se unidades do resultado e referência forem diferentes, prioriza a do resultado
              const unidade = unidadeResultado || unidadeRef;

              parametros.push({
                chave: "fosforo",
                nome: "Fósforo",
                valor,
                unidade,
                refMin,
                refMax,
                status
              });
            }
          }
        }
      }

      console.log("Parâmetros interpretados (parser fósforo):", parametros);
      return parametros;
    }


    // REGISTROS
    const formRegistro = document.getElementById("form-registro");
    const divListaRegistros = document.getElementById("lista-registros");
    const filtroRegDataInicio = document.getElementById("filtro-reg-data-inicio");
    const filtroRegDataFim = document.getElementById("filtro-reg-data-fim");
    const filtroRegTexto = document.getElementById("filtro-reg-texto");
    const btnLimparFiltroReg = document.getElementById("btn-limpar-filtro-reg");

    let registroEditandoId = null;

    formRegistro.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (tipoUsuario === "vet") {
        alert("Veterinário(a) não pode inserir registros diários.");
        return;
      }
      const ownerUid = getOwnerUidParaEscrita();
      if (!ownerUid) {
        alert("Usuário não identificado.");
        return;
      }

      const data = document.getElementById("data").value;
      const peso = document.getElementById("peso").value;
      const obs = document.getElementById("obs").value;
      const baseRef = ref(db, "tutores/" + ownerUid + "/registros");

      if (registroEditandoId) {
        await update(ref(db, "tutores/" + ownerUid + "/registros/" + registroEditandoId), {
          data,
          peso,
          obs
        });
        alert("Registro atualizado!");
        registroEditandoId = null;
      } else {
        await push(baseRef, {
          data,
          peso,
          obs,
          criadoEm: new Date().toISOString()
        });
        alert("Registro salvo!");
      }

      formRegistro.reset();
    });

    function aplicarFiltrosRegistros() {
      let lista = registrosCache.slice();
      const di = filtroRegDataInicio.value;
      const df = filtroRegDataFim.value;
      const txt = filtroRegTexto.value.trim().toLowerCase();

      if (di) {
        lista = lista.filter(([id, r]) => (r.data || "") >= di);
      }
      if (df) {
        lista = lista.filter(([id, r]) => (r.data || "") <= df);
      }
      if (txt) {
        lista = lista.filter(([id, r]) => (r.obs || "").toLowerCase().includes(txt));
      }

      divListaRegistros.innerHTML = "";
      if (!lista.length) {
        divListaRegistros.innerHTML = "<p>Nenhum registro encontrado com os filtros atuais.</p>";
        return;
      }

      const ownerUid = getOwnerUidParaLeitura();

      for (const [id, reg] of lista) {
        const div = document.createElement("div");
        div.className = "registro";
        let html = `
          <strong>Data:</strong> ${reg.data || "-"}<br>
          <strong>Peso:</strong> ${reg.peso || "-"} kg<br>
          <strong>Obs:</strong> ${reg.obs || ""}<br>
        `;
        html += `<div id="comentarios-registro-${id}"></div>`;
        html += `<div class="botoes-registro"></div><small>ID: ${id}</small>`;
        div.innerHTML = html;

        const botoesDiv = div.querySelector(".botoes-registro");

        if (tipoUsuario !== "vet") {
          const btnEditar = document.createElement("button");
          btnEditar.type = "button";
          btnEditar.textContent = "Editar";
          btnEditar.addEventListener("click", () => {
            registroEditandoId = id;
            document.getElementById("data").value = reg.data || "";
            document.getElementById("peso").value = reg.peso || "";
            document.getElementById("obs").value = reg.obs || "";
            mostrar(secRegistros);
          });
          botoesDiv.appendChild(btnEditar);

          const btnExcluir = document.createElement("button");
          btnExcluir.type = "button";
          btnExcluir.textContent = "Excluir";
          btnExcluir.addEventListener("click", async () => {
            const ok = window.confirm("Tem certeza que deseja excluir este registro?");
            if (ok) {
              await remove(ref(db, "tutores/" + ownerUid + "/registros/" + id));
            }
          });
          botoesDiv.appendChild(btnExcluir);
        }

        onValue(ref(db, "tutores/" + ownerUid + "/comentariosRegistros/" + id), (snapC) => {
          const area = div.querySelector("#comentarios-registro-" + id);
          area.innerHTML = "";
          const todos = snapC.val();
          if (!todos) return;
          Object.values(todos).forEach((c) => {
            const p = document.createElement("div");
            p.className = "comentario";
            p.textContent = `${c.autorNome || "Vet"} (${c.crmv || ""}): ${c.texto}`;
            area.appendChild(p);
          });
        });

        if (tipoUsuario === "vet") {
          const blocoComent = document.createElement("div");
          blocoComent.style.marginTop = "8px";
          blocoComent.innerHTML = `
            <label for="comentario-reg-${id}">Comentário do veterinário</label>
            <textarea id="comentario-reg-${id}" rows="2"></textarea>
            <button type="button" data-acao="comentar-registro" data-id="${id}">Salvar comentário</button>
          `;
          div.appendChild(blocoComent);

          blocoComent
            .querySelector("button[data-acao='comentar-registro']")
            .addEventListener("click", async () => {
              if (!uidTutorAutorizador && crmvUsuario) {
                alert("Ainda não há tutor que autorizou seu CRMV.");
                return;
              }
              const textarea = document.getElementById("comentario-reg-" + id);
              const texto = textarea.value.trim();
              if (!texto) {
                alert("Digite um comentário.");
                return;
              }
              const ownerUidW = getOwnerUidParaEscrita();
              const refComentarios = ref(db, "tutores/" + ownerUidW + "/comentariosRegistros/" + id);
              await push(refComentarios, {
                texto,
                autorUid: usuarioAtual?.uid || null,
                autorNome: nomeUsuario,
                crmv: crmvUsuario,
                criadoEm: new Date().toISOString()
              });
              textarea.value = "";
            });
        }

        divListaRegistros.appendChild(div);
      }
    }

    function iniciarListenerRegistros(ownerUid) {
      onValue(ref(db, "tutores/" + ownerUid + "/registros"), (snapshot) => {
        const dados = snapshot.val();
        if (!dados) {
          registrosCache = [];
          divListaRegistros.innerHTML = "<p>Ainda não há registros.</p>";
          return;
        }
        const lista = Object.entries(dados);
        lista.sort((a, b) => {
          const d1 = new Date(a[1].criadoEm || 0);
          const d2 = new Date(b[1].criadoEm || 0);
          return d2 - d1;
        });
        registrosCache = lista;
        aplicarFiltrosRegistros();
      });

      [filtroRegDataInicio, filtroRegDataFim, filtroRegTexto].forEach((el) => {
        el.addEventListener("input", aplicarFiltrosRegistros);
      });
      btnLimparFiltroReg.addEventListener("click", () => {
        filtroRegDataInicio.value = "";
        filtroRegDataFim.value = "";
        filtroRegTexto.value = "";
        aplicarFiltrosRegistros();
      });
    }

    // EXAMES
    const formExame = document.getElementById("form-exame");
    const divListaExames = document.getElementById("lista-exames");
    const inputArquivoExame = document.getElementById("arquivo-exame");
    const inputExameId = document.getElementById("exame-id");
    const btnCancelarEdicao = document.getElementById("btn-cancelar-edicao");
    let arquivoExameFile = null;

    const filtroExDataInicio = document.getElementById("filtro-ex-data-inicio");
    const filtroExDataFim = document.getElementById("filtro-ex-data-fim");
    const filtroExTipo = document.getElementById("filtro-ex-tipo");
    const filtroExTexto = document.getElementById("filtro-ex-texto");
    const btnLimparFiltroEx = document.getElementById("btn-limpar-filtro-ex");

    // NOVOS ELEMENTOS DE GRÁFICOS
    const selectGraficoTipoExame = document.getElementById("grafico-tipo-exame");
    const selectGraficoTipo = document.getElementById("grafico-tipo");
    const listaExamesGrafico = document.getElementById("lista-exames-grafico");
    const btnGerarGrafico = document.getElementById("btn-gerar-grafico");
    const areaGraficoRenderizado = document.getElementById("area-grafico-renderizado");

    inputArquivoExame.addEventListener("change", () => {
      const file = inputArquivoExame.files[0];
      arquivoExameFile = file || null;
    });

    function limparFormularioExame() {
      formExame.reset();
      inputExameId.value = "";
      arquivoExameFile = null;
      btnCancelarEdicao.style.display = "none";
    }

    btnCancelarEdicao.addEventListener("click", () => {
      limparFormularioExame();
    });

    formExame.addEventListener("submit", async (e) => {
      e.preventDefault();
      const idExistente = inputExameId.value || null;
      if (tipoUsuario === "vet" && idExistente) {
        alert("Veterinário(a) só pode cadastrar novos exames, não editar existentes.");
        return;
      }

      const ownerUid = getOwnerUidParaEscrita();
      if (!ownerUid) {
        alert("Nenhum tutor associado a este exame.");
        return;
      }

      const dataExame = document.getElementById("data-exame").value;
      const tipoExame = document.getElementById("tipo-exame").value;
      const desc = document.getElementById("descricao-exame").value;

      let arquivoURL = null;

      if (arquivoExameFile) {
        const caminho = `exames/${ownerUid}/${Date.now()}_${arquivoExameFile.name}`;
        const arqRef = sRef(storage, caminho);
        await uploadBytes(arqRef, arquivoExameFile);
        arquivoURL = await getDownloadURL(arqRef);
      }

      let exameId = idExistente || null;

      if (idExistente && tipoUsuario !== "vet") {
        const dadosUpdate = {
          dataExame,
          tipoExame,
          desc
        };
        if (arquivoURL) dadosUpdate.arquivoURL = arquivoURL;
        await update(ref(db, "tutores/" + ownerUid + "/exames/" + idExistente), dadosUpdate);
        alert("Exame atualizado!");
      } else {
        const dados = {
          dataExame,
          tipoExame,
          desc,
          criadoEm: new Date().toISOString()
        };
        if (arquivoURL) dados.arquivoURL = arquivoURL;
        const examesRef = ref(db, "tutores/" + ownerUid + "/exames");
        const novoRef = await push(examesRef, dados);
        exameId = novoRef.key;
        alert("Exame salvo!");
      }

      // Se tiver PDF, tentar extrair laudo e salvar resultados por parâmetro
      if (arquivoExameFile && arquivoURL && exameId) {
        try {
          const textoLaudo = await extrairTextoDoPDF(arquivoExameFile);
          const parametros = analisarLaudoLaboratorial(textoLaudo);

          for (const p of parametros) {
            const refParam = ref(
              db,
              `tutores/${ownerUid}/resultadosExames/${p.chave}/${exameId}`
            );
            await set(refParam, {
              dataExame,
              tipoExame,
              laboratorio: null,
              valor: p.valor,
              unidade: p.unidade,
              refMin: p.refMin,
              refMax: p.refMax,
              status: p.status,
              nomeParametro: p.nome,
              arquivoURL
            });
          }
        } catch (err) {
          console.error("Erro ao extrair/analisar laudo:", err);
          alert("Exame salvo, mas houve erro ao interpretar automaticamente o PDF.");
        }
      }

      limparFormularioExame();
    });

    function aplicarFiltrosExames() {
      let lista = examesCache.slice();
      const di = filtroExDataInicio.value;
      const df = filtroExDataFim.value;
      const tipo = filtroExTipo.value;
      const txt = filtroExTexto.value.trim().toLowerCase();

      if (di) {
        lista = lista.filter(([id, ex]) => (ex.dataExame || "") >= di);
      }
      if (df) {
        lista = lista.filter(([id, ex]) => (ex.dataExame || "") <= df);
      }
      if (tipo) {
        lista = lista.filter(([id, ex]) => (ex.tipoExame || "") === tipo);
      }
      if (txt) {
        lista = lista.filter(([id, ex]) => (ex.desc || "").toLowerCase().includes(txt));
      }

      divListaExames.innerHTML = "";
      if (!lista.length) {
        divListaExames.innerHTML = "<p>Nenhum exame encontrado com os filtros atuais.</p>";
        return;
      }

      const ownerUid = getOwnerUidParaLeitura();

      for (const [id, ex] of lista) {
        const div = document.createElement("div");
        div.className = "registro";
        const temArquivo = !!ex.arquivoURL;

        let html = `
          <strong>Data:</strong> ${ex.dataExame || "-"}<br>
          <strong>Tipo:</strong> ${ex.tipoExame || "-"}<br>
          <strong>Desc.:</strong> ${ex.desc || ""}<br>
          ${
            temArquivo
              ? `<a href="${ex.arquivoURL}" target="_blank">Abrir arquivo</a><br>`
              : "<em>Sem arquivo anexado</em><br>"
          }
        `;
        html += `<div id="comentarios-${id}"></div>`;
        html += `<div class="botoes-exame"></div><small>ID: ${id}</small>`;
        div.innerHTML = html;

        const botoesDiv = div.querySelector(".botoes-exame");

        if (tipoUsuario !== "vet") {
          const btnEditar = document.createElement("button");
          btnEditar.type = "button";
          btnEditar.textContent = "Editar";
          btnEditar.addEventListener("click", () => {
            inputExameId.value = id;
            document.getElementById("data-exame").value = ex.dataExame || "";
            document.getElementById("tipo-exame").value = ex.tipoExame || "";
            document.getElementById("descricao-exame").value = ex.desc || "";
            arquivoExameFile = null;
            inputArquivoExame.value = "";
            btnCancelarEdicao.style.display = "inline-block";
            mostrar(secExames);
          });
          botoesDiv.appendChild(btnEditar);

          const btnExcluir = document.createElement("button");
          btnExcluir.type = "button";
          btnExcluir.textContent = "Excluir";
          btnExcluir.addEventListener("click", async () => {
            const ok = window.confirm("Tem certeza que deseja excluir este exame?");
            if (ok) {
              await remove(ref(db, "tutores/" + ownerUid + "/exames/" + id));
            }
          });
          botoesDiv.appendChild(btnExcluir);
        } else {
          const infoVet = document.createElement("em");
          infoVet.textContent = " (Você pode comentar ou criar novos exames; os existentes são do tutor.)";
          botoesDiv.appendChild(infoVet);
        }

        onValue(ref(db, "tutores/" + ownerUid + "/comentarios/" + id), (snapC) => {
          const area = div.querySelector("#comentarios-" + id);
          area.innerHTML = "";
          const todos = snapC.val();
          if (!todos) return;
          Object.values(todos).forEach((c) => {
            const p = document.createElement("div");
            p.className = "comentario";
            p.textContent = `${c.autorNome || "Vet"} (${c.crmv || ""}): ${c.texto}`;
            area.appendChild(p);
          });
        });

        if (tipoUsuario === "vet") {
          const blocoComent = document.createElement("div");
          blocoComent.style.marginTop = "8px";
          blocoComent.innerHTML = `
            <label for="comentario-${id}">Comentário do veterinário</label>
            <textarea id="comentario-${id}" rows="2"></textarea>
            <button type="button" data-acao="comentar" data-id="${id}">Salvar comentário</button>
          `;
          div.appendChild(blocoComent);

          blocoComent
            .querySelector("button[data-acao='comentar']")
            .addEventListener("click", async () => {
              if (!uidTutorAutorizador && crmvUsuario) {
                alert("Ainda não há tutor que autorizou seu CRMV.");
                return;
              }
              const textarea = document.getElementById("comentario-" + id);
              const texto = textarea.value.trim();
              if (!texto) {
                alert("Digite um comentário.");
                return;
              }
              const ownerUidW = getOwnerUidParaEscrita();
              const refComentarios = ref(db, "tutores/" + ownerUidW + "/comentarios/" + id);
              await push(refComentarios, {
                texto,
                autorUid: usuarioAtual?.uid || null,
                autorNome: nomeUsuario,
                crmv: crmvUsuario,
                criadoEm: new Date().toISOString()
              });
              textarea.value = "";
            });
        }

        divListaExames.appendChild(div);
      }

      // Sempre atualizar lista de exames para gráficos quando filtros mudam
      atualizarListaExamesParaGraficos();
    }

    function iniciarListenerExames(ownerUid) {
      onValue(ref(db, "tutores/" + ownerUid + "/exames"), (snapshot) => {
        const dados = snapshot.val();
        if (!dados) {
          examesCache = [];
          divListaExames.innerHTML = "<p>Ainda não há exames.</p>";
          listaExamesGrafico.innerHTML = "<em>Não há exames cadastrados.</em>";
          return;
        }
        const lista = Object.entries(dados);
        lista.sort((a, b) => {
          const d1 = new Date(a[1].dataExame || a[1].criadoEm || 0);
          const d2 = new Date(b[1].dataExame || b[1].criadoEm || 0);
          return d2 - d1;
        });
        examesCache = lista;
        aplicarFiltrosExames();
      });

      [filtroExDataInicio, filtroExDataFim, filtroExTipo, filtroExTexto].forEach((el) => {
        el.addEventListener("input", aplicarFiltrosExames);
      });
      btnLimparFiltroEx.addEventListener("click", () => {
        filtroExDataInicio.value = "";
        filtroExDataFim.value = "";
        filtroExTipo.value = "";
        filtroExTexto.value = "";
        aplicarFiltrosExames();
      });

      // Eventos para gráficos
      selectGraficoTipoExame.addEventListener("change", atualizarListaExamesParaGraficos);
      btnGerarGrafico.addEventListener("click", gerarGraficoExames);
    }

    // MONTAGEM DA LISTA DE EXAMES PARA GRÁFICOS
    function atualizarListaExamesParaGraficos() {
      const tipoSelecionado = selectGraficoTipoExame.value;
      listaExamesGrafico.innerHTML = "";

      if (!examesCache.length) {
        listaExamesGrafico.innerHTML = "<em>Não há exames cadastrados.</em>";
        return;
      }
      if (!tipoSelecionado) {
        listaExamesGrafico.innerHTML = "<em>Selecione um tipo de exame acima.</em>";
        return;
      }

      const examesFiltrados = examesCache.filter(([id, ex]) => ex.tipoExame === tipoSelecionado);

      if (!examesFiltrados.length) {
        listaExamesGrafico.innerHTML = "<em>Não há exames deste tipo.</em>";
        return;
      }

      examesFiltrados.forEach(([id, ex]) => {
        const label = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = id;
        cb.className = "chk-exame-grafico";
        label.appendChild(cb);
        const texto = document.createTextNode(
          ` ${ex.dataExame || "-"} - ${ex.desc || "(sem descrição)"}`
        );
        label.appendChild(texto);
        listaExamesGrafico.appendChild(label);
      });

      // Limitar a seleção a 10
      listaExamesGrafico.addEventListener("change", (e) => {
        if (e.target && e.target.classList.contains("chk-exame-grafico")) {
          const marcados = listaExamesGrafico.querySelectorAll(".chk-exame-grafico:checked");
          if (marcados.length > 10) {
            e.target.checked = false;
            alert("Selecione no máximo 10 exames para o gráfico.");
          }
        }
      }, { once: true });
    }

    // "RENDERIZAÇÃO" SIMPLES DO GRÁFICO (TEXTO ESTRUTURADO)
    async function gerarGraficoExames() {
      const tipoExameGraf = selectGraficoTipoExame.value;
      const tipoGrafico = selectGraficoTipo.value;
      if (!tipoExameGraf) {
        alert("Selecione o tipo de exame para o gráfico.");
        return;
      }

      const checks = listaExamesGrafico.querySelectorAll(".chk-exame-grafico:checked");
      if (!checks.length) {
        alert("Selecione pelo menos um exame.");
        return;
      }
      if (checks.length > 10) {
        alert("Selecione no máximo 10 exames.");
        return;
      }

      const ownerUid = getOwnerUidParaLeitura();
      if (!ownerUid) {
        alert("Nenhum tutor associado.");
        return;
      }

      const idsSelecionados = Array.from(checks).map(c => c.value);

      // Para simplificar: pegar dados dos examesCache para esses IDs
      const examesSelecionados = examesCache
        .filter(([id]) => idsSelecionados.includes(id))
        .map(([id, ex]) => ({ id, ...ex }))
        .sort((a, b) => (a.dataExame || "").localeCompare(b.dataExame || ""));

      // Montar uma saída de texto estruturada (conceito de gráfico)
      let saida = `Tipo de exame: ${tipoExameGraf}\n`;
      saida += `Tipo de gráfico: ${tipoGrafico}\n`;
      saida += `Exames selecionados (${examesSelecionados.length}):\n\n`;

      examesSelecionados.forEach((ex, idx) => {
        saida += `(${idx + 1}) ID=${ex.id}\n`;
        saida += `  Data: ${ex.dataExame || "-"}\n`;
        saida += `  Descrição: ${ex.desc || "(sem descrição)"}\n`;
        saida += `  Arquivo: ${ex.arquivoURL ? "sim" : "não"}\n\n`;
      });

      saida += "Neste momento o gráfico é conceitual (texto).\n";
      saida += "Aqui seria usado Chart.js ou outra biblioteca para plotar, usando as datas como eixo X e os valores extraídos dos laudos como eixo Y.\n";

      areaGraficoRenderizado.textContent = saida;
    }

    // RECEITAS / PEDIDOS
    const formReceita = document.getElementById("form-receita");
    const divListaReceitas = document.getElementById("lista-receitas");
    const inputArquivoReceita = document.getElementById("arquivo-receita");
    let arquivoReceitaFile = null;

    const filtroRecTipo = document.getElementById("filtro-rec-tipo");
    const filtroRecTexto = document.getElementById("filtro-rec-texto");
    const btnLimparFiltroRec = document.getElementById("btn-limpar-filtro-rec");

    let receitaEditandoId = null;

    inputArquivoReceita.addEventListener("change", () => {
      const file = inputArquivoReceita.files[0];
      arquivoReceitaFile = file || null;
    });

    formReceita.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (tipoUsuario !== "vet") {
        alert("Somente o veterinário pode cadastrar receitas/pedidos.");
        return;
      }
      const ownerUid = getOwnerUidParaEscrita();
      if (!ownerUid) {
        alert("Nenhum tutor associado.");
        return;
      }
      const tipoRec = document.getElementById("tipo-receita").value;
      const descRec = document.getElementById("descricao-receita").value.trim();
      const comentRec = document.getElementById("comentario-receita").value.trim();

      if (!tipoRec || !descRec) {
        alert("Preencha tipo e descrição.");
        return;
      }

      let arquivoURL = null;
      if (arquivoReceitaFile) {
        const caminho = `receitas/${ownerUid}/${Date.now()}_${arquivoReceitaFile.name}`;
        const recRefStorage = sRef(storage, caminho);
        await uploadBytes(recRefStorage, arquivoReceitaFile);
        arquivoURL = await getDownloadURL(recRefStorage);
      } else if (!receitaEditandoId) {
        alert("Selecione um arquivo PDF para anexar.");
        return;
      }

      if (receitaEditandoId) {
        const dadosUpdate = {
          tipo: tipoRec,
          descricao: descRec,
          comentarioVet: comentRec || null
        };
        if (arquivoURL) dadosUpdate.arquivoURL = arquivoURL;
        await update(ref(db, "tutores/" + ownerUid + "/receitas/" + receitaEditandoId), dadosUpdate);
        alert("Receita/pedido atualizado!");
        receitaEditandoId = null;
      } else {
        const dados = {
          tipo: tipoRec,
          descricao: descRec,
          comentarioVet: comentRec || null,
          arquivoURL,
          criadoEm: new Date().toISOString(),
          autorUid: usuarioAtual?.uid || null,
          autorNome: nomeUsuario,
          crmv: crmvUsuario
        };
        const receitasRef = ref(db, "tutores/" + ownerUid + "/receitas");
        await push(receitasRef, dados);
        alert("Receita/pedido salvo!");
      }

      formReceita.reset();
      arquivoReceitaFile = null;
    });

    function aplicarFiltrosReceitas() {
      let lista = receitasCache.slice();
      const tipo = filtroRecTipo.value;
      const txt = filtroRecTexto.value.trim().toLowerCase();

      if (tipo) {
        lista = lista.filter(([id, r]) => (r.tipo || "") === tipo);
      }
      if (txt) {
        lista = lista.filter(([id, r]) => {
          const base = (r.descricao || "") + " " + (r.comentarioVet || "");
          return base.toLowerCase().includes(txt);
        });
      }

      divListaReceitas.innerHTML = "";
      if (!lista.length) {
        divListaReceitas.innerHTML = "<p>Nenhuma receita/pedido encontrado com os filtros atuais.</p>";
        return;
      }

      const ownerUid = getOwnerUidParaLeitura();

      for (const [id, rec] of lista) {
        const div = document.createElement("div");
        div.className = "registro";
        let html = `
          <strong>Tipo:</strong> ${rec.tipo || "-"}<br>
          <strong>Descrição:</strong> ${rec.descricao || ""}<br>
          <strong>Comentário do vet:</strong> ${rec.comentarioVet || "-"}<br>
          <a href="${rec.arquivoURL}" target="_blank">Abrir PDF</a><br>
          <small>Criado por: ${rec.autorNome || ""} (${rec.crmv || ""})</small><br>
          <small>ID: ${id}</small>
        `;
        html += `<div class="botoes-receita"></div>`;
        div.innerHTML = html;

        const botoesDiv = div.querySelector(".botoes-receita");
        if (tipoUsuario !== "vet") {
          const btnExcluir = document.createElement("button");
          btnExcluir.type = "button";
          btnExcluir.textContent = "Excluir";
          btnExcluir.addEventListener("click", async () => {
            const ok = window.confirm("Tem certeza que deseja excluir esta receita/pedido?");
            if (ok) {
              await remove(ref(db, "tutores/" + ownerUid + "/receitas/" + id));
            }
          });
          botoesDiv.appendChild(btnExcluir);
        } else {
          const btnEditar = document.createElement("button");
          btnEditar.type = "button";
          btnEditar.textContent = "Editar";
          btnEditar.addEventListener("click", () => {
            receitaEditandoId = id;
            document.getElementById("tipo-receita").value = rec.tipo || "";
            document.getElementById("descricao-receita").value = rec.descricao || "";
            document.getElementById("comentario-receita").value = rec.comentarioVet || "";
            inputArquivoReceita.value = "";
            arquivoReceitaFile = null;
            mostrar(secReceitas);
          });
          botoesDiv.appendChild(btnEditar);
        }

        divListaReceitas.appendChild(div);
      }
    }

    function iniciarListenerReceitas(ownerUid) {
      onValue(ref(db, "tutores/" + ownerUid + "/receitas"), (snapshot) => {
        const dados = snapshot.val();
        if (!dados) {
          receitasCache = [];
          divListaReceitas.innerHTML = "<p>Ainda não há receitas ou pedidos.</p>";
          return;
        }
        const lista = Object.entries(dados);
        lista.sort((a, b) => {
          const d1 = new Date(a[1].criadoEm || 0);
          const d2 = new Date(b[1].criadoEm || 0);
          return d2 - d1;
        });
        receitasCache = lista;
        aplicarFiltrosReceitas();
      });

      [filtroRecTipo, filtroRecTexto].forEach((el) => {
        el.addEventListener("input", aplicarFiltrosReceitas);
      });
      btnLimparFiltroRec.addEventListener("click", () => {
        filtroRecTipo.value = "";
        filtroRecTexto.value = "";
        aplicarFiltrosReceitas();
      });
    }
  </script>
</body>
</html>
